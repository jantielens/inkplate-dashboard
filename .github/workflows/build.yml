name: Build Firmware

on:
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      board:
        description: 'Board to build (inkplate2, inkplate5v2, inkplate10, inkplate6flick, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - inkplate2
          - inkplate5v2
          - inkplate10
          - inkplate6flick

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare:
    name: Prepare build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.board }}" = "all" ]; then
              echo 'matrix=["inkplate2","inkplate5v2","inkplate10","inkplate6flick"]' >> $GITHUB_OUTPUT
            else
              echo 'matrix=["${{ github.event.inputs.board }}"]' >> $GITHUB_OUTPUT
            fi
          else
            echo 'matrix=["inkplate2","inkplate5v2","inkplate10","inkplate6flick"]' >> $GITHUB_OUTPUT
          fi
  
  build:
    name: Build ${{ matrix.board }}
    runs-on: ubuntu-latest
    needs: prepare
    
    strategy:
      matrix:
        board: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: ${{ runner.os }}-arduino-cli-1.3.1-${{ hashFiles('**/arduino-cli.yaml', '**/setup.ps1') }}
          restore-keys: |
            ${{ runner.os }}-arduino-cli-1.3.1-
      
      - name: Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh -s 1.3.1
          arduino-cli version
      
      - name: Install Arduino core and libraries
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set library.enable_unsafe_install true
          arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/SolderedElectronics/Dasduino-Board-Definitions-for-Arduino-IDE/master/package_Dasduino_Boards_index.json
          arduino-cli core install Inkplate_Boards:esp32 --additional-urls https://raw.githubusercontent.com/SolderedElectronics/Dasduino-Board-Definitions-for-Arduino-IDE/master/package_Dasduino_Boards_index.json
          arduino-cli lib install "InkplateLibrary"
          arduino-cli lib install "PubSubClient"
      
      - name: Build firmware
        run: |
          chmod +x build.sh
          ./build.sh ${{ matrix.board }}
      
      - name: Get firmware size
        id: size
        run: |
          BIN_FILE="build/${{ matrix.board }}/${{ matrix.board }}.ino.bin"
          if [ -f "$BIN_FILE" ]; then
            SIZE=$(stat -f%z "$BIN_FILE" 2>/dev/null || stat -c%s "$BIN_FILE" 2>/dev/null)
            SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
            echo "✅ Firmware size: ${SIZE_MB} MB (${SIZE} bytes)"
          else
            echo "❌ Firmware binary not found"
            exit 1
          fi
      
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}
          path: build/${{ matrix.board }}/${{ matrix.board }}.ino.bin
          retention-days: 30
  
  comment-summary:
    name: Comment PR with build summary
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate build summary
        id: summary
        run: |
          boards='${{ needs.prepare.outputs.matrix }}'
          boards_array=$(echo "$boards" | jq -r '.[]')
          
          summary="## Firmware Build Summary\n\n"
          summary+="All board configurations built successfully!\n\n"
          summary+="| Board | Size (MB) | Size (bytes) |\n"
          summary+="|-------|-----------|-------------|\n"
          
          for board in $boards_array; do
            bin_file="artifacts/firmware-${board}/${board}.ino.bin"
            if [ -f "$bin_file" ]; then
              size=$(stat -f%z "$bin_file" 2>/dev/null || stat -c%s "$bin_file" 2>/dev/null)
              size_mb=$(echo "scale=2; $size / 1048576" | bc)
              summary+="| \`${board}\` | ${size_mb} MB | ${size} bytes |\n"
            fi
          done
          
          summary+="\nFirmware artifacts available in the Actions run for download."
          
          # Escape for GitHub Actions output
          summary="${summary//'%'/'%25'}"
          summary="${summary//$'\n'/'%0A'}"
          summary="${summary//$'\r'/'%0D'}"
          echo "summary=$summary" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.summary.outputs.summary }}`.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Firmware Build Summary')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

